// src/popup.js

document.addEventListener('DOMContentLoaded', () => {
  const saveBtn = document.getElementById('saveKeyBtn');
  const testBtn = document.getElementById('testKeyBtn');
  const apiKeyInput = document.getElementById('apiKeyInput');

  // Load existing key from storage if it exists to show the user
  chrome.storage.local.get(['geminiApiKey'], (result) => {
    if (result.geminiApiKey) {
      apiKeyInput.value = result.geminiApiKey;
    }
  });

  // Handle Saving the Key
  saveBtn.addEventListener('click', () => {
    const apiKey = apiKeyInput.value.trim();

    if (!apiKey) {
      alert('Please enter an API key!');
      return;
    }

    chrome.storage.local.set({ geminiApiKey: apiKey }, () => {
      alert('API Key saved successfully!');
    });
  });

  // Handle Testing the Key via the Background Script
  testBtn.addEventListener('click', async () => {
    const apiKey = apiKeyInput.value.trim();

    if (!apiKey) {
      alert('Please enter an API key to test!');
      return;
    }

    // First, save it just in case they didn't hit save
    await chrome.storage.local.set({ geminiApiKey: apiKey });

    // Send message to background.js to perform the AI test
    chrome.runtime.sendMessage({
      action: "generate",
      prompt: "Confirm if this API key is working by saying: 'Connection Successful!'",
      extract: "System Test"
    }, (response) => {
      if (chrome.runtime.lastError) {
        alert("Error: Could not contact background script.");
        return;
      }

      if (response && response.result) {
        alert(response.result);
      } else {
        alert("Failed to get a response. Check your internet and API key.");
      }
    });
  });
});
